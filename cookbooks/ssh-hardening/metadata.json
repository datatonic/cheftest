{"name":"ssh-hardening","version":"2.8.0","description":"This cookbook installs and provides secure ssh and sshd configurations.","long_description":"# ssh-hardening (Chef cookbook)\n\n[![Supermarket](http://img.shields.io/cookbook/v/ssh-hardening.svg)][1]\n[![Build Status](https://travis-ci.org/dev-sec/chef-ssh-hardening.svg?branch=master)][2]\n[![Code Coverage](http://img.shields.io/coveralls/dev-sec/chef-ssh-hardening.svg)][3]\n[![Gitter Chat](https://badges.gitter.im/Join%20Chat.svg)][4]\n\n## Description\n\nThis cookbook provides secure ssh-client and ssh-server configurations. This cookbook does not provide capabilities for management of users and/or ssh keys, please use other cookbooks for that.\n\n## Requirements\n\n* Chef >= 14.13.11\n\n### Platform\n\n- Debian 8, 9, 10\n- Ubuntu 16.04, 18.04\n- RHEL 6, 7\n- CentOS 6, 7\n- Oracle Linux 6, 7\n- Fedora 29, 30\n- OpenSuse Leap 42\n- Amazon Linux 1, 2\n\n## Attributes\n\nBelow you can find the attribute documentation and their default values.\n\nNotice: Some of attribute defaults of this cookbook are set in the recipes. You should use a higher [attribute precedence](https://docs.chef.io/attributes.html#attribute-precedence) level for overriding of such attributes. Such attributes are flagged with `#override attribute#` in the list below. Example for overriding a such attribute:\n\n```ruby\noverride['ssh-hardening']['ssh']['server']['listen_to'] = node['ipaddress']\n```\n\n* `['ssh-hardening']['network']['ipv6']['enable']` - `false`. Set to true if IPv6 is needed\n* `['ssh-hardening']['ssh']['ports']` - `22`. Ports to which ssh-server should listen to and ssh-client should connect to\n* `['ssh-hardening']['ssh'][{'client', 'server'}]['kex']` - `nil` to calculate best key-exchange (KEX) based on server version, otherwise specify a string of Kex values\n* `['ssh-hardening']['ssh'][{'client', 'server'}]['mac']` - `nil` to calculate best Message Authentication Codes (MACs) based on server version, otherwise specify a string of Mac values\n* `['ssh-hardening']['ssh'][{'client', 'server'}]['cipher']` - `nil` to calculate best ciphers based on server version, otherwise specify a string of Cipher values\n* `['ssh-hardening']['ssh'][{'client', 'server'}]['cbc_required']` - `false`. Set to `true` if CBC for ciphers is required. This is usually only necessary, if older M2M mechanism need to communicate with SSH, that don't have any of the configured secure ciphers enabled. CBC is a weak alternative. Anything weaker should be avoided and is thus not available.\n* `['ssh-hardening']['ssh'][{'client', 'server'}]['weak_hmac']` - `false`. Set to `true` if weaker HMAC mechanisms are required. This is usually only necessary, if older M2M mechanism need to communicate with SSH, that don't have any of the configured secure HMACs enabled.\n* `['ssh-hardening']['ssh'][{'client', 'server'}]['weak_kex']` - `false`. Set to `true` if weaker Key-Exchange (KEX) mechanisms are required. This is usually only necessary, if older M2M mechanism need to communicate with SSH, that don't have any of the configured secure KEXs enabled.\n* `['ssh-hardening']['ssh']['client']['remote_hosts']` - `[]` - one or more hosts, to which ssh-client can connect to.\n* `['ssh-hardening']['ssh']['client']['password_authentication']` - `false`. Set to `true` if password authentication should be enabled.\n* `['ssh-hardening']['ssh']['client']['roaming']` - `false`. Set to `true` if experimental client roaming should be enabled. This is known to cause potential issues with secrets being disclosed to malicious servers and defaults to being disabled.\n* `['ssh-hardening']['ssh']['client']['extras']` - `{}`. Add extra configuration options, see [below](#extra-configuration-options) for details\n* `['ssh-hardening']['ssh']['server']['host_key_files']` - `nil` to calculate best hostkey configuration based on server version, otherwise specify an array with file paths (e.g. `/etc/ssh/ssh_host_rsa_key`)\n* `['ssh-hardening']['ssh']['server']['dh_min_prime_size']` - `2048` - Minimal acceptable prime length in bits in `/etc/ssh/moduli`. Primes below this number will get removed. (See [this](https://entropux.net/article/openssh-moduli/) for more information and background)\n* `['ssh-hardening']['ssh']['server']['dh_build_primes']` - `false` - If own primes should be built. This rebuild happens only once and takes a lot of time (~ 1.5 - 2h on the modern hardware for 4096 length).\n* `['ssh-hardening']['ssh']['server']['dh_build_primes_size']` - `4096` - Prime length which should be generated. This option is only valid if `dh_build_primes` is enabled.\n* `['ssh-hardening']['ssh']['server']['listen_to']` `#override attribute#` - one or more ip addresses, to which ssh-server should listen to. Default is to listen on all interfaces. It should be configured for security reasons!\n* `['ssh-hardening']['ssh']['server']['allow_root_with_key']` - `false` to disable root login altogether. Set to `true` to allow root to login via key-based mechanism\n* `['ssh-hardening']['ssh']['server']['allow_tcp_forwarding']` - `false`. Set to `true` to allow TCP Forwarding\n* `['ssh-hardening']['ssh']['server']['allow_agent_forwarding']` - `false`. Set to `true` to allow Agent Forwarding\n* `['ssh-hardening']['ssh']['server']['allow_x11_forwarding']` - `false`. Set to `true` to allow X11 Forwarding\n* `['ssh-hardening']['ssh']['server']['permit_tunnel']` - `false` to disable tun device forwarding. Set to `true` to allow tun device forwarding. Other accepted values: 'yes', 'no', 'point-to-point', 'ethernet'. See `man sshd_config` for exact behaviors. Note: you'll also need to enable `allow_tcp_forwarding`.\n* `['ssh-hardening']['ssh']['server']['use_pam']` - `true`. Set to `false` to disable the pam authentication of sshd\n* `['ssh-hardening']['ssh']['server']['challenge_response_authentication']` - `false`. Set to `true` to enable challenge response authentication.\n* `['ssh-hardening']['ssh']['server']['deny_users']` - `[]` to configure `DenyUsers`, if specified login is disallowed for user names that match one of the patterns.\n* `['ssh-hardening']['ssh']['server']['allow_users']` - `[]` to configure `AllowUsers`, if specified, login is allowed only for user names that match one of the patterns.\n* `['ssh-hardening']['ssh']['server']['deny_groups']` - `[]` to configure `DenyGroups`, if specified, login is disallowed for users whose primary group or supplementary group list matches one of the patterns.\n* `['ssh-hardening']['ssh']['server']['allow_groups']` - `[]` to configure `AllowGroups`, if specified, login is allowed only for users whose primary group or supplementary group list matches one of the patterns.\n* `['ssh-hardening']['ssh']['server']['print_motd']` - `false`. Set to `true` to enable printing of the MOTD\n* `['ssh-hardening']['ssh']['server']['print_last_log']` - `false`. Set to `true` to enable printing of last login information\n* `['ssh-hardening']['ssh']['server']['banner']` - `nil`. Set a path like '/etc/issue.net' to enable the banner\n* `['ssh-hardening']['ssh']['server']['os_banner']` - `false` to disable version information during the protocol handshake (debian family only). Set to `true` to enable it\n* `['ssh-hardening']['ssh']['server']['use_dns']` - `nil` to use the openssh default. Set to `true` or `false` to enable/disable the DNS lookup and check of remote host\n* `['ssh-hardening']['ssh']['server']['use_privilege_separation']` - `nil` to calculate the best value based on server version, otherwise set `true` or `false`\n* `['ssh-hardening']['ssh']['server']['login_grace_time']` - `30s`. Time in which the login should be successfully, otherwise the user is disconnected.\n* `['ssh-hardening']['ssh']['server']['max_auth_tries']` - `2`. The number of authentication attempts per connection\n* `['ssh-hardening']['ssh']['server']['max_sessions']` - `10` The number of sessions per connection\n* `['ssh-hardening']['ssh']['server']['password_authentication']` - `false`. Set to `true` if password authentication should be enabled\n* `['ssh-hardening']['ssh']['server']['log_level']` - `verbose`. The log level of sshd. See `LogLevel` in `man 5 sshd_config` for possible values.\n* `['ssh-hardening']['ssh']['server']['sftp']['enable']` - `false`. Set to `true` to enable the SFTP feature of OpenSSH daemon\n* `['ssh-hardening']['ssh']['server']['sftp']['group']` - `sftponly`. Sets the `Match Group` option of SFTP to allow SFTP only for dedicated users\n* `['ssh-hardening']['ssh']['server']['sftp']['chroot']` - `/home/%u`. Sets the directory where the SFTP user should be chrooted\n* `['ssh-hardening']['ssh']['server']['sftp']['password_authentication']` - `false`. Set to `true` if password authentication should be enabled\n* `['ssh-hardening']['ssh']['server']['authorized_keys_path']` - `nil`. If not nil, full path to an authorized keys folder is expected\n* `['ssh-hardening']['ssh']['server']['extras']` - `{}`. Add extra configuration options, see [below](#extra-configuration-options) for details\n* `['ssh-hardening']['ssh']['server']['match_blocks']` - `{}`. Match configuration block, see [below](#match-configuration-options-for-sshd) for details\n\n## Usage\n\nAdd the recipes to the run_list:\n\n    \"recipe[ssh-hardening]\"\n\nThis will install ssh-server and ssh-client. You can alternatively choose only one via:\n\n    \"recipe[ssh-hardening::server]\"\n    \"recipe[ssh-hardening::client]\"\n\nConfigure attributes:\n\n    \"ssh-hardening\": {\n      \"ssh\" : {\n        \"server\" : {\n          \"listen_to\" : \"10.2.3.4\"\n        }\n      }\n    }\n\n**The default value for `listen_to` is `0.0.0.0`. It is highly recommended to change the value.**\n\n## SFTP\n\nTo enable the SFTP configuration add one of the following recipes to the run_list:\n\n    \"recipe[ssh-hardening]\"\n    or\n    \"recipe[ssh-hardening::server]\"\n\nConfigure attributes:\n\n    \"ssh-hardening\": {\n      \"ssh\" : {\n        \"server\": {\n          \"sftp\" : {\n          \"enable\" : true,\n          \"chroot\" : \"/home/sftp/%u\",\n          \"group\"  : \"sftusers\"\n        }\n        }\n      }\n    }\n\nThis will enable the SFTP Server and chroot every user in the `sftpusers` group to the `/home/sftp/%u` directory.\n\n## Extra Configuration Options\nExtra configuration options can be appended to the client or server configuration files.  This can be used to override statically set values, or add configuration options not otherwise available via attributes.\n\nThe syntax is as follows:\n```\n# => Extra Server Configuration\ndefault['ssh-hardening']['ssh']['server']['extras'].tap do |extra|\n  extra['#Some Comment'] = 'Heres the Comment'\n  extra['AuthenticationMethods'] =  'publickey,keyboard-interactive'\nend\n\n# => Extra Client Configuration\ndefault['ssh-hardening']['ssh']['client']['extras'].tap do |extra|\n  extra['PermitLocalCommand'] = 'no'\n  extra['Tunnel'] =  'no'\nend\n```\n\n## Match Configuration Options for sshd\nMatch blocks have to be placed by the end of sshd_config. This can be achieved by using the `match_blocks` attribute tree:\n\n```\ndefault['ssh-hardening']['ssh']['server']['match_blocks'].tap do |match|\n  match['User root'] = <<~ROOT\n    AuthorizedKeysFile .ssh/authorized_keys\n  ROOT\n  match['User git'] = <<~GIT\n    Banner none\n    AuthorizedKeysCommand /bin/false\n    AuthorizedKeysFile .ssh/authorized_keys\n    GSSAPIAuthentication no\n    PasswordAuthentication no\n  GIT\nend\n```\n\n## Local Testing\n\nPlease install [chef-dk](https://downloads.chef.io/chefdk), [VirtualBox](https://www.virtualbox.org/) or VMware Workstation and [Vagrant](https://www.vagrantup.com/).\n\nLinting is checked with [rubocop](https://github.com/bbatsov/rubocop) and [foodcritic](http://www.foodcritic.io/):\n\n```bash\n$ chef exec rake lint\n.....\n```\n\nUnit/spec tests are done with [chefspec](https://github.com/sethvargo/chefspec):\n\n```bash\n$ chef exec rake spec\n.....\n```\n\nIntegration tests are done with [test-kitchen](http://kitchen.ci/) and [inspec](https://www.inspec.io/):\n\n```bash\n$ chef exec rake kitchen\n.....\n# or you can use the kitchen directly\n$ kitchen test\n```\n\n## FAQ / Pitfalls\n\n**I can't log into my account. I have registered the client key, but it still doesn't let me it.**\n\nIf you have exhausted all typical issues (firewall, network, key missing, wrong key, account disabled etc.), it may be that your account is locked. The quickest way to find out is to look at the password hash for your user:\n\n    sudo grep myuser /etc/shadow\n\nIf the hash includes an `!`, your account is locked:\n\n    myuser:!:16280:7:60:7:::\n\nThe proper way to solve this is to unlock the account (`passwd -u myuser`). If the user doesn't have a password, you should can unlock it via:\n\n    usermod -p \"*\" myuser\n\nAlternatively, if you intend to use PAM, you enabled it via `['ssh-hardening']['ssh']['use_pam'] = true`. PAM will allow locked users to get in with keys.\n\n\n**Why doesn't my application connect via SSH anymore?**\n\nAlways look into log files first and if possible look at the negotation between client and server that is completed when connecting.\n\nWe have seen some issues in applications (based on python and ruby) that are due to their use of an outdated crypto set. This collides with this hardening module, which reduced the list of ciphers, message authentication codes (MACs) and key exchange (KEX) algorithms to a more secure selection.\n\nIf you find this isn't enough, feel free to activate the attributes `cbc_requires` for ciphers, `weak_hmac` for MACs and `weak_kex`for KEX in the namespaces `['ssh-hardening']['ssh']['client']` or `['ssh-hardening']['ssh']['server']` based on where you want to support them.\n\n**Why can't I log to the SFTP server after I added a user to my SFTP group?**\n\nThis is a ChrootDirectory ownership problem. sshd will reject SFTP connections to accounts that are set to chroot into any directory that has ownership/permissions that sshd considers insecure. sshd's strict ownership/permissions requirements dictate that every directory in the chroot path must be owned by root and only writable by the owner. So, for example, if the chroot environment is /home must be owned by root.\n\nSee [https://wiki.archlinux.org/index.php/SFTP_chroot](https://wiki.archlinux.org/index.php/SFTP_chroot)\n\n## Contributors + Kudos\n\n* Dominik Richter [arlimus](https://github.com/arlimus)\n* Christoph Hartmann [chris-rock](https://github.com/chris-rock)\n* Bernhard Weisshuhn (a.k.a. bernhorst) [bkw](https://github.com/bkw)\n* Patrick Munch [atomic111](https://github.com/atomic111)\n* Edmund Haselwanter [ehaselwanter](https://github.com/ehaselwanter)\n* Dana Merrick [dmerrick](https://github.com/dmerrick)\n* Anton Rieder [aried3r](https://github.com/aried3r)\n* Trent Petersen [Rockstar04](https://github.com/Rockstar04)\n* Petri Sirkkala [sirkkalap](https://github.com/sirkkalap)\n* Jan Klare [jklare](https://github.com/jklare)\n* Zac Hallett [zhallett](https://github.com/zhallett)\n* Petri Sirkkala [sirkkalap](https://github.com/sirkkalap)\n* [stribika](https://github.com/stribika)\n\nThis cookbook is mostly based on guides by:\n\n* [NSA: Guide to the Secure Configuration of Red Hat Enterprise Linux 5](https://www.iad.gov/iad/library/ia-guidance/security-configuration/operating-systems/guide-to-the-secure-configuration-of-red-hat-enterprise.cfm)\n* [Deutsche Telekom, Group IT Security, Security Requirements (German)](https://www.telekom.com/psa)\n\nThanks to all of you!!\n\n## Contributing\n\nSee [contributor guideline](CONTRIBUTING.md).\n\n## License and Author\n\n* Author:: Dominik Richter <dominik.richter@googlemail.com>\n* Author:: Deutsche Telekom AG\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n[1]: https://supermarket.getchef.com/cookbooks/ssh-hardening\n[2]: http://travis-ci.org/dev-sec/chef-ssh-hardening\n[3]: https://coveralls.io/r/dev-sec/chef-ssh-hardening\n[4]: https://gitter.im/dev-sec/general\n","maintainer":"Dominik Richter","maintainer_email":"dominik.richter@googlemail.com","license":"Apache-2.0","platforms":{"ubuntu":">= 12.04","debian":">= 6.0","centos":">= 5.0","redhat":">= 5.0","oracle":">= 6.4","fedora":">= 23.0","suse":">= 0.0.0","opensuse":">= 13.2","opensuseleap":">= 42.1","amazon":">= 0.0.0"},"dependencies":{},"recommendations":{},"suggestions":{},"conflicting":{},"providing":{},"replacing":{},"attributes":{},"groupings":{},"recipes":{"ssh-hardening::default":"installs and configures ssh client and server","ssh-hardening::client":"install and apply security hardening for ssh client","ssh-hardening::server":"install and apply security hardening for ssh server"},"source_url":"https://github.com/dev-sec/chef-ssh-hardening","issues_url":"https://github.com/dev-sec/chef-ssh-hardening/issues","chef_version":[[">= 12.5"]],"ohai_version":[]}